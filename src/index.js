var keyMatrixEng = [
  [
    { value: ['~', '`'], id: 192 },
    { value: ['1', '!'], id: 49 },
    { value: ['2', '@'], id: 50 },
    { value: ['3', '#'], id: 51 },
    { value: ['4', '$'], id: 52 },
    { value: ['5', '%'], id: 53 },
    { value: ['6', '^'], id: 54 },
    { value: ['7', '&'], id: 55 },
    { value: ['8', '*'], id: 56 },
    { value: ['9', '('], id: 57 },
    { value: ['0', ')'], id: 48 },
    { value: ['-', '_'], id: 189 },
    { value: ['=', '+'], id: 187 },
    { value: ['BKSP', 'BKSP'], id: 8 },
  ],
  [
    { value: ['TAB', 'TAB'], id: 9 },
    { value: ['q', 'Q'], id: 81 },
    { value: ['w', 'W'], id: 87 },
    { value: ['e', 'E'], id: 69 },
    { value: ['r', 'R'], id: 82 },
    { value: ['t', 'T'], id: 84 },
    { value: ['y', 'Y'], id: 89 },
    { value: ['u', 'U'], id: 85 },
    { value: ['i', 'I'], id: 73 },
    { value: ['o', 'O'], id: 79 },
    { value: ['p', 'P'], id: 80 },
    { value: ['[', '{'], id: 219 },
    { value: [']', '}'], id: 221 },
    { value: ['\\', '|'], id: 221 },
  ],
  [
    { value: ['CAPS', 'CAPS'], id: 20 },
    { value: ['a', 'A'], id: 65 },
    { value: ['s', 'S'], id: 83 },
    { value: ['d', 'D'], id: 68 },
    { value: ['f', 'F'], id: 70 },
    { value: ['g', 'G'], id: 71 },
    { value: ['h', 'H'], id: 72 },
    { value: ['j', 'J'], id: 74 },
    { value: ['k', 'K'], id: 75 },
    { value: ['l', 'L'], id: 76 },
    { value: [';', ':'], id: 186 },
    { value: ['\'', '"'], id: 222 },
    { value: ['ENTER', 'ENTER'], id: 13 },
  ],
  [
    { value: ['SHIFT', 'SHIFT'], id: 16 },
    { value: ['z', 'Z'], id: 90 },
    { value: ['x', 'X'], id: 88 },
    { value: ['c', 'C'], id: 67 },
    { value: ['v', 'V'], id: 86 },
    { value: ['b', 'B'], id: 66 },
    { value: ['n', 'N'], id: 78 },
    { value: ['m', 'M'], id: 77 },
    { value: [',', '<'], id: 188 },
    { value: ['.', '>'], id: 190 },
    { value: ['/', '?'], id: 191 },
    { value: ['&#8593;', '&#8593;'], id: 38 },
    { value: ['SHIFT', 'SHIFT'], id: 16 },
  ],
  [
    { value: ['CTRL', 'CTRL'], id: 17 },
    { value: ['WIN', 'WIN'], id: 91 },
    { value: ['ALT', 'ALT'], id: 18 },
    { value: ['SPACE', 'SPACE'], id: 32 },
    { value: ['ALT', 'ALT'], id: 18 },
    { value: ['&#8592;', '&#8592;'], id: 37 },
    { value: ['&#8595;', '&#8595;'], id: 40 },
    { value: ['&#8594;', '&#8594;'], id: 39 },
    { value: ['CTRL', 'CTRL'], id: 17 },
  ],
];

var keyMatrixRus = [
  [
    { value: ['ё', 'Ё'], id: 192 },
    { value: ['1', '!'], id: 49 },
    { value: ['2', '@'], id: 50 },
    { value: ['3', '#'], id: 51 },
    { value: ['4', '$'], id: 52 },
    { value: ['5', '%'], id: 53 },
    { value: ['6', '^'], id: 54 },
    { value: ['7', '&'], id: 55 },
    { value: ['8', '*'], id: 56 },
    { value: ['9', '('], id: 57 },
    { value: ['0', ')'], id: 48 },
    { value: ['-', '_'], id: 189 },
    { value: ['=', '+'], id: 187 },
    { value: ['BKSP', 'BKSP'], id: 8 },
  ],
  [
    { value: ['TAB', 'TAB'], id: 9 },
    { value: ['й', 'Й'], id: 81 },
    { value: ['ц', 'Ц'], id: 87 },
    { value: ['у', 'У'], id: 69 },
    { value: ['к', 'К'], id: 82 },
    { value: ['е', 'Е'], id: 84 },
    { value: ['н', 'Н'], id: 89 },
    { value: ['г', 'Г'], id: 85 },
    { value: ['ш', 'Ш'], id: 73 },
    { value: ['щ', 'Щ'], id: 79 },
    { value: ['з', 'З'], id: 80 },
    { value: ['х', 'Х'], id: 219 },
    { value: ['ъ', 'Ъ'], id: 221 },
    { value: ['\\', '|'], id: 221 },
  ],
  [
    { value: ['CAPS', 'CAPS'], id: 20 },
    { value: ['ф', 'Ф'], id: 65 },
    { value: ['ы', 'Ы'], id: 83 },
    { value: ['в', 'В'], id: 68 },
    { value: ['а', 'А'], id: 70 },
    { value: ['п', 'П'], id: 71 },
    { value: ['р', 'Р'], id: 72 },
    { value: ['о', 'О'], id: 74 },
    { value: ['л', 'Л'], id: 75 },
    { value: ['д', 'Д'], id: 76 },
    { value: ['ж', 'Ж'], id: 186 },
    { value: ['э', 'Э'], id: 222 },
    { value: ['ENTER', 'ENTER'], id: 13 },
  ],
  [
    { value: ['SHIFT', 'SHIFT'], id: 16 },
    { value: ['я', 'Я'], id: 90 },
    { value: ['ч', 'Ч'], id: 88 },
    { value: ['с', 'С'], id: 67 },
    { value: ['м', 'М'], id: 86 },
    { value: ['и', 'И'], id: 66 },
    { value: ['т', 'Т'], id: 78 },
    { value: ['ь', 'Ь'], id: 77 },
    { value: ['б', 'Б'], id: 188 },
    { value: ['ю', 'Ю'], id: 190 },
    { value: ['.', ','], id: 191 },
    { value: ['&#8593;', '&#8593;'], id: 38 },
    { value: ['SHIFT', 'SHIFT'], id: 16 },
  ],
  [
    { value: ['CTRL', 'CTRL'], id: 17 },
    { value: ['WIN', 'WIN'], id: 91 },
    { value: ['ALT', 'ALT'], id: 18 },
    { value: ['SPACE', 'SPACE'], id: 32 },
    { value: ['ALT', 'ALT'], id: 18 },
    { value: ['&#8592;', '&#8592;'], id: 37 },
    { value: ['&#8595;', '&#8595;'], id: 40 },
    { value: ['&#8594;', '&#8594;'], id: 39 },
    { value: ['CTRL', 'CTRL'], id: 17 },
  ],
];

var shift = false;
var shiftHandler = function (keyCode, type) {
  if (keyCode === 16) {
    switch (type) {
      case 'keydown':
        shift = true;
        break;
      case 'keyup':
        shift = false;
        break;
      default:
        shift = false;
        break;
    }
  }
};

var btnAction = (el, {id, childNodes}) => {
  if ((id > 46 && id < 91) || (id > 185 && id < 223)) {
    let symbol = Array.from(childNodes).find((elem) => document.querySelectorAll('prime')).innerText;
    if (shift) symbol = symbol.toUpperCase();
    return `${el.value}${symbol}`;
  }
  if (id === '32') { return `${el.value} `; }
  if (id === '13') { return `${el.value}\n`; }
  if (id === '8') {
    var size = el.value.length;
    if (size > 1) return el.value.slice(0, size - 1);
    return '';
  }
  if (id === '46') {
    return '';
  }
  return undefined;
};
var pressHandler = ({ target, type }, code) => {
  let elem = null;
  let res = null;
  if (code) elem = document.getElementById(`${code}`);
  else elem = target.closest('.key');
  var text = document.querySelector('.textarea');
  text.style.overflowY = 'auto';
  switch (type) {
    case 'mousedown':
      elem.classList.add('active');
      res = btnAction(text, elem);
      if (res !== undefined || res != null) {
        text.value = res;
      }
      break;
    case 'mouseup':
      elem.classList.remove('active');
      break;
    case 'keydown':
      elem.classList.add('active');
      res = btnAction(text, elem);
      if (res !== undefined || res != null) {
        text.value = res;
      }
      break;
    case 'keyup':
      elem.classList.remove('active');
      break;
    default:
      break;
  }
};

var keyHandler = (event) => {
  const code = event.keyCode;
  shiftHandler(event);
  pressHandler(event, code);
};

const button = ({ id, value }) => {
  const btn = document.createElement('div');
  btn.classList.add('key');
  btn.id = id;
  if (id === 32) { btn.style.flexGrow = '25'; }
  if (id > 7 && id < 21 && id !== 17 && id !== 18) { btn.style.flexGrow = '1'; }
  btn.prepend(...value.map((el, index) => {
    const span = document.createElement('span');
    span.innerHTML = el;
    if (!shift) {
      if (index === 0) { span.classList.add('prime'); }
    } else if (index === 1) { span.classList.add('prime'); }
    span.style.display = 'block';
    return span;
  }));
  return btn;
};

const rows = function (keys) {
  const rowBuffer = keys.map(((el) => button(el)));
  const rows = document.createElement('div');
  rows.classList.add('row');
  rows.append(...rowBuffer);
  return rows;
};

const keyboard = () => {
  const keyboard = document.createElement('div');
  keyboard.classList.add('keyboard');
  keyMatrixEng.map(((el) => keyboard.append(rows(el))));
  keyboard.addEventListener('mousedown', pressHandler);
  keyboard.addEventListener('mouseup', pressHandler);
  return keyboard;
};

const textarea = () => {
  const textarea = document.createElement('textarea');
  textarea.classList.add('textarea');
  textarea.setAttribute('cols', 150);
  textarea.setAttribute('rows', 20);
  return textarea;
};

const wrap = () => {
  const wrapper = document.createElement('div');
  wrapper.classList.add('wrapper');
  wrapper.prepend(textarea(), keyboard());
  return wrapper;
};

const app = () => {
  const page = document.querySelector('body');
  page.prepend(wrap());
};

window.addEventListener('load', app);
document.addEventListener('keydown', keyHandler);
document.addEventListener('keyup', keyHandler);
